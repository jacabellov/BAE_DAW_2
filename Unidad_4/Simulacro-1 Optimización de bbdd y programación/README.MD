## üéØ Objetivo

Consolidar el uso de los principales componentes de MySQL:

- √çndices
- Vistas
- Funciones
- Procedimientos

---

## üß± Enunciado del ejercicio

La empresa "TecnoMarket" quiere analizar las ventas realizadas por sus clientes. Para ello, necesita organizar la informaci√≥n en su base de datos y optimizar el rendimiento de las consultas.

## üìò Parte 1: Creaci√≥n de tablas

```sql
CREATE TABLE clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100),
    ciudad VARCHAR(50)
);

CREATE TABLE productos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100),
    precio DECIMAL(10, 2)
);

CREATE TABLE ventas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    producto_id INT,
    fecha DATE,
    cantidad INT,
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (producto_id) REFERENCES productos(id)
);
INSERT INTO productos (id, nombre, precio) VALUES
(1, 'Laptop', 1200.00),
(2, 'Teclado', 50.00),
(3, 'Monitor', 300.00);

INSERT INTO ventas (id, cliente_id, producto_id, fecha, cantidad) VALUES
(1, 1, 1, '2024-05-01', 1),
(2, 1, 2, '2024-05-12', 2),
(3, 2, 3, '2024-05-13', 1),
(4, 3, 2, '2024-05-14', 1);
```

<img src=img/img1.png>

## üîç Parte 2: Creaci√≥n de √≠ndices

Crea los siguientes clientes:

- **idx_ciudad** sobre la tabla clientes y el campo ciudad.
- **idx_fecha** sobre la tabla ventas, y el campo fecha.

```sql
CREATE INDEX idx_ciudad ON clientes(ciudad);

CREATE INDEX idx_fecha ON ventas(fecha);
```
### ¬øPreguntas?

- Crea los indices, muestra su rendimiento, y explica si son √≥ptimos y por qu√©?.

# INDICES CREADOS

<img src=img/img2.png>

<img src=img/img3.png> 

# RENDIMIENTO DE ESOS INDICES

<img src=img/img4.png>

<img src=img/img5.png>

# EXPLICA SI SON OPTIMOS Y POR QUE?

Estos √≠ndices son √≥ptimos porque permiten que MySQL acceda m√°s r√°pido a los datos sin tener que revisar todas las filas de la tabla, lo que mejora mucho el rendimiento de las consultas. Adem√°s, como estas tablas se usan principalmente para consultar y no tanto para modificar, el uso de √≠ndices no afecta negativamente el rendimiento general.

---

## üëÅÔ∏è Parte 3: Crear una vista

- **Obt√©n, a trav√©s de una vista**, la siguiente informaci√≥n detallada de cada venta:

- ID de la venta
- Nombre del cliente
- Producto vendido
- Fecha de la venta
- Cantidad comprada
- Total gastado (precio √ó cantidad)

La vista **vista** que consolida los datos de las tablas `ventas`, `clientes` y `productos`, permitiendo consultar f√°cilmente el historial de ventas detallado.

> **RECUERDA**: Una vista es una **consulta sql** encapsulada en una tabla ficticia.

### üìä Resultado esperado

| venta_id | cliente     | producto | fecha       | cantidad | total   |
|----------|-------------|----------|-------------|----------|---------|
| 1        | Ana P√©rez   | Laptop   | 2024-05-01  | 1        | 1200.00 |
| 2        | Ana P√©rez   | Teclado  | 2024-05-12  | 2        | 100.00  |
| 3        | Luis G√≥mez  | Monitor  | 2024-05-13  | 1        | 300.00  |
| 4        | Carla Ruiz  | Teclado  | 2024-05-14  | 1        | 50.00   |

RESPUESTA

# CREACIOND DE LA VISTA

```SQL
CREATE VIEW vista_ventas_detalladas AS
SELECT
    v.id AS venta_id,
    c.nombre AS cliente,
    p.nombre AS producto,
    v.fecha,
    v.cantidad,
    p.precio * v.cantidad AS total
FROM ventas v
JOIN clientes c ON v.cliente_id = c.id
JOIN productos p ON v.producto_id = p.id;
```

# CONSULTANDO LA VISTA

```SQL
SELECT * FROM vista_ventas_detalladas;
```
# RESULTADO FINAL

<img src=img/img6.png>

---

## üßÆ Parte 4: Crear una funci√≥n

Crea una **funci√≥n almacenada** en MySQL llamada `calcular_total` que reciba los siguientes par√°metros:

- `precio`: un valor decimal con dos decimales (precio del producto)
- `cantidad`: un n√∫mero entero que representa las unidades compradas

La funci√≥n debe devolver el resultado de multiplicar ambos valores, es decir, el **total a pagar** por esa l√≠nea de venta.

```sql
SELECT calcular_total(1200.00, 2);
```

| calcular_total(1200.00, 2) |
|----------------------------|
| 2400.00                    |

# FUNCION

```SQL
CREATE FUNCTION CALCULAR_TOTAL(PRECIO DECIMAL(10,2), CANTIDAD INT) RETURNS DECIMAL(10,2) DETERMINISTIC RETURN PRECIO * CANTIDAD;
```
# EJECUCION

<img src=img/img7.png>
---

## ‚öôÔ∏è Parte 5: Crear un procedimiento

Crea un procedimiento llamado `resumen_cliente` que reciba como par√°metro el **ID de un cliente** (`cliente_id`), y que devuelva el **historial de ventas** de dicho cliente.  
El procedimiento debe mostrar los siguientes datos por cada venta realizada por ese cliente:

- El **nombre del cliente**
- La **fecha de la venta**
- El **nombre del producto**
- La **cantidad comprada**
- El **total de la l√≠nea de venta**, calculado como `precio * cantidad`

üí° **Sugerencia:** Puedes reutilizar una funci√≥n existente (como `calcular_total`) o calcular el total directamente en la consulta.

```sql
CALL resumen_cliente(1);
```

Con el siguiente resultado: 

| nombre     | fecha       | producto   | cantidad | total   |
|------------|-------------|------------|----------|---------|
| Ana P√©rez | 2024-05-01  | Laptop     | 1        | 1200.00 |
| Ana P√©rez | 2024-05-12  | Teclado    | 2        | 100.00  |

> *Este resultado depende de los datos que se hayan insertado en la base de datos.*

# CREACION DEL PROCEDIMIENTO

CREATE PROCEDURE RESUMEN_CLIENTE(IN CLIENTE_ID INT) BEGIN SELECT C.NOMBRE AS NOMBRE, V.FECHA, P.NOMBRE AS PRODUCTO, V.CANTIDAD, P.PRECIO * V.CANTIDAD AS TOTAL FROM VENTAS V JOIN CLIENTES C ON V.CLIENTE_ID = C.ID JOIN PRODUCTOS P ON V.PRODUCTO_ID = P.ID WHERE C.ID = CLIENTE_ID; END;

# RESULTADO DEL PROCEDIMIENTO

```SQL
CALL resumen_cliente(1);
```
<IMG SRC='IMG/img8.png'>

---

## ‚ùì Preguntas te√≥ricas

1. ¬øQu√© ventajas ofrece el uso de una vista en lugar de una consulta con m√∫ltiples `JOIN`?

Usar una vista facilita el trabajo porque encapsula una consulta compleja en una "tabla virtual"

2. ¬øPor qu√© es importante declarar una funci√≥n como `DETERMINISTIC`?

Es importante porque indica que la funci√≥n siempre devuelve el mismo resultado si se le dan los mismos valores.

3. ¬øCu√°l es la diferencia entre una funci√≥n y un procedimiento?

La funci√≥n devuelve un √∫nico valor y se usa dentro de consultas (SELECT calcular_total(...)). El procedimiento puede devolver resultados m√°s complejos (como tablas) y no se usa dentro de un SELECT, sino que se ejecuta con CALL. Adem√°s, la funci√≥n no puede modificar datos, pero el procedimiento s√≠.

4. ¬øQu√© impacto tienen los √≠ndices sobre el rendimiento de una base de datos?

Los √≠ndices mejoran mucho la velocidad de b√∫squeda, ordenamiento y filtrado de datos. Sin ellos, MySQL tiene que revisar toda la tabla fila por fila.

5. ¬øCu√°ndo se recomienda usar un trigger en lugar de un procedimiento?

Se recomienda usar un trigger cuando quiero que una acci√≥n ocurra autom√°ticamente como reacci√≥n a un evento (como insertar, actualizar o borrar una fila).

---

## üìù Preguntas pr√°cticas

1. Modifica el procedimiento para filtrar tambi√©n por un rango de fechas.

```SQL
CREATE PROCEDURE RESUMEN_CLIENTE(IN CLIENTE_ID INT, IN FECHA_INICIO DATE, IN FECHA_FIN DATE)
BEGIN
    SELECT 
        C.NOMBRE AS NOMBRE, 
        V.FECHA, 
        P.NOMBRE AS PRODUCTO, 
        V.CANTIDAD, 
        P.PRECIO * V.CANTIDAD AS TOTAL
    FROM VENTAS V
    JOIN CLIENTES C ON V.CLIENTE_ID = C.ID
    JOIN PRODUCTOS P ON V.PRODUCTO_ID = P.ID
    WHERE C.ID = CLIENTE_ID AND V.FECHA BETWEEN FECHA_INICIO AND FECHA_FIN;
END;
```

2. Crea un √≠ndice sobre la columna `producto_id` en la tabla `ventas`.

```SQL
CREATE INDEX IDX_PRODUCTO ON VENTAS(PRODUCTO_ID);
```

3. ¬øQu√© ocurre si insertas una venta con un `cliente_id` inexistente?

Dar√° un error, porque la columna cliente_id en ventas tiene una clave for√°nea (FOREIGN KEY) que impide insertar un valor que no exista en la tabla clientes.

4. Modifica la vista para incluir tambi√©n el nombre de la ciudad del cliente.

```SQL
CREATE VIEW VISTA_VENTAS_DETALLADAS AS 
SELECT 
    V.ID AS VENTA_ID, 
    C.NOMBRE AS CLIENTE, 
    C.CIUDAD, 
    P.NOMBRE AS PRODUCTO, 
    V.FECHA, 
    V.CANTIDAD, 
    P.PRECIO * V.CANTIDAD AS TOTAL
FROM VENTAS V
JOIN CLIENTES C ON V.CLIENTE_ID = C.ID
JOIN PRODUCTOS P ON V.PRODUCTO_ID = P.ID;
```

5. Agrega una validaci√≥n en el procedimiento para evitar resultados si el cliente no existe.

```SQL
CREATE PROCEDURE RESUMEN_CLIENTE(IN CLIENTE_ID INT) BEGIN IF EXISTS (SELECT 1 FROM CLIENTES WHERE ID = CLIENTE_ID) THEN SELECT C.NOMBRE AS NOMBRE, V.FECHA, P.NOMBRE AS PRODUCTO, V.CANTIDAD, P.PRECIO * V.CANTIDAD AS TOTAL FROM VENTAS V JOIN CLIENTES C ON V.CLIENTE_ID = C.ID JOIN PRODUCTOS P ON V.PRODUCTO_ID = P.ID WHERE C.ID = CLIENTE_ID; ELSE SELECT 'CLIENTE NO EXISTE' AS MENSAJE_*_
```
---